<html>
    <head>
        <style>
                @font-face { font-family: Roboto; src: url('Roboto-Regular.ttf'); } 
                html{
                    height:100%;
                    margin:0;
                    font-family: Roboto;
                }
                body{
                    height:100%;
                    margin:0;
                }
                .customMap{
                    position: absolute;
                    top:0;
                    left:0;
                    bottom:0;
                    right:0;
                    width:100%;
                    height:100%;
                    background:#a2bbb5;
                }
                #switcher{
                    position: absolute;
                    top:0;
                    left:4em;
                    width:auto;
                    height: auto;
                    z-index: 401;
                }
                #switcherCity{
                    position: absolute;
                    top: 0;
                    left: 12em;
                    width: auto;
                    height: auto;
                    z-index: 401;
                }
                #switcherResumenes{
                    position: absolute;
                    top: 0;
                    left: 20em;
                    width: auto;
                    height: auto;
                    z-index: 401;
                }
                #textoResumen{
                    position: absolute;
                    display: block;
                    margin-left: auto;
                    margin-right: auto;
                    top: 10rem;
                    left: 25%;
                    width: 50%;
                    height: auto;
                    z-index: 501;
                    background-color: rgba(10,10,10,0.6);
                    padding:1em;
                    display:none;
                    color:white;
                }
                #legendTable, #NPCTable{
                    position: absolute;
                    display: block;
                    margin-left: auto;
                    margin-right: auto;
                    top: 14rem;
                    left:4em;
                    height: auto;
                    z-index: 401;
                    background-color: rgba(10,10,10,0.6);
                    padding:1em;
                    color:white;
                    display:none;
                }
                #legendToggle{
                    position: absolute;
                    top:10em;
                    left:4em;
                    width:auto;
                    height: auto;
                    z-index: 401;
                }
                #NPCToggle{
                    position: absolute;
                    top:12em;
                    left:4em;
                    width:auto;
                    height: auto;
                    z-index: 401;
                }
                .NPCSwitcher{
                    text-align: center;
                } 
                .buttonswitcher{
                    display:block;
                    margin-right:auto;
                    margin-left:auto;
                    width:7em;
                    border-radius: 5px;
                    background-color:rgba(10,10,10,0.6);
                    color:white;
                }
                ul{
                    padding:inherit !important;
                }
                .leaflet-popup-content-wrapper, .leaflet-popup-tip{
                    background: rgba(10,10,10,0.6) !important;
                    color: white !important;
                }
                .leaflet-container a {
                    color:white !important;
                    cursor:pointer;
                }
                
        </style>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>
    <body>
        <div id="legendToggle">
            <button class="buttonswitcher" id="legendToggler" onclick="toggleLegendTable()">Leyenda</button>
        </div>
        <table id="legendTable">
        </table>
        <div id="NPCToggle">
            <button class="buttonswitcher" id="NPCToggler" onclick="toggleLegendNPC()">NPC</button>
        </div>
        <table id="NPCTable">
        </table>
        <div id="switcher">
            <button class="buttonswitcher" id="normal">Mapa estándar</button>
            <button class="buttonswitcher" id="regions">Mapa regiones</button>
            <button class="buttonswitcher" id="topo">Mapa topográfico</button>
            <button class="buttonswitcher" id="bio">Mapa biomas</button>
        </div>
        <div id="switcherCity">
            <button class="buttonswitcher" id="couria">Couria</button>
            <ul class="listaSwitcher couriaUL" style="display:none">
                <li class="elementoSwitcher couriaLi">
                    <button class="buttonswitcher couriaButton cityClick" link="Filtana" id="filtana">Filtana</button>
                </li>
                <li class="elementoSwitcher couriaLi">
                    <button class="buttonswitcher couriaButton cityClick" link="Lati" id="lati">Lati</button>
                </li>
                <li class="elementoSwitcher couriaLi">
                    <button class="buttonswitcher couriaButton cityClick" link="Parta" id="parta">Parta</button>
                </li>
                <li class="elementoSwitcher couriaLi">
                    <button class="buttonswitcher couriaButton cityClick" link="Veno" id="veno">Veno</button>
                </li> 
            </ul>
            <button class="buttonswitcher" id="herug">Herug</button>
            <ul class="listaSwitcher herugUL" style="display:none">
                <li class="elementoSwitcher herugLi">
                    <button class="buttonswitcher herugButton cityClick" link="Gonfenoire" id="gonfenoire">Gonfenoire</button>
                </li>
            </ul>
            <button class="buttonswitcher notYet" id="lagros">Lagros</button>
            <button class="buttonswitcher notYet" id="nowe">Nowe</button>
            <button class="buttonswitcher notYet" id="ocresyn">Ocresyn</button>
            <button class="buttonswitcher notYet" id="perterra">Perterra</button>
            <button class="buttonswitcher notYet" id="vopna">Vopna</button>
        </div>
        <div id="switcherResumenes">
            <button class="buttonswitcher" id="resumenes" onclick="getResumen()">Resúmenes</button>
            <ul class="listaSwitcher resumenesUL" style="display:none">
                
            </ul>
        </div>
        <div id="textoResumen" onclick="removeThisAndHide()">
        </div>
        <script>
            const BBDD = {
                "world":{
                    "Couria":{
                        "markers":{
                            "Filtana":{
                                "location":[13.603278,49.724121],
                                "draggable":false,
                                "bindPopup":"Capital de Couria: <a onclick='openTheCity(`Filtana`)'>Filtana</a>"
                            },
                            "Lati":{
                                "location":[3.601142, 62.841797],
                                "draggable":false,
                                "bindPopup":"<a onclick='openTheCity(`Lati`)'>Lati</a>",
                                "tipoCiudad":"pueblo"
                            },
                            "Parta":{
                                "location":[11.781325, 49.020996],
                                "draggable":false,
                                "bindPopup":"<a onclick='openTheCity(`Parta`)'>Parta</a>",
                                "tipoCiudad":"ciudad"
                            },
                            "Veno":{
                                "location":[10.01213, 42.209473],
                                "draggable":false,
                                "bindPopup":"<a onclick='openTheCity(`Veno`)'>Veno</a>",
                                "tipoCiudad":"ciudad"
                            }
                        },
                        "icons":{
                            "Filtana":{
                                "iconUrl":"leaflet/images/couria.png",
                                "iconSize":[60,60],
                                "iconAnchor":[30,60],
                                "popupAnchor": [0,-40]
                            },
                            "pueblo":{
                                "iconUrl":"leaflet/images/icons/pueblo.png",
                                "iconSize":[45,45],
                                "iconAnchor":[22,45],
                                "popupAnchor": [0,-25]
                            },
                            "ciudad":{
                                "iconUrl":"leaflet/images/icons/ciudad.png",
                                "iconSize":[45,45],
                                "iconAnchor":[22,45],
                                "popupAnchor": [0,-25]
                            }
                        }
                    },
                    "Herug":{
                        "markers":{
                            "Iunelon":{
                                "location":[4.412137, 74.267578],
                                "draggable":false,
                                "icon":"IunelonIcon",
                                "bindPopup":"Capital de Herug: <a onclick='openTheCity(`Iunelon`)'>Iunelon</a>"
                            },
                            "Gonfenoire":{
                                "location":[-3.052754, 78.376465],
                                "draggable":false,
                                "bindPopup":"<a onclick='openTheCity(`Gonfenoire`)'>Gonfenoire</a>",
                                "tipoCiudad":"ciudad"
                            }
                        },
                        "icons":{
                            "Iunelon":{
                                "iconUrl":"leaflet/images/herug.png",
                                "iconSize":[60,60],
                                "iconAnchor":[30,60],
                                "popupAnchor": [0,-40]
                            },
                            "pueblo":{
                                "iconUrl":"leaflet/images/icons/pueblo.png",
                                "iconSize":[45,45],
                                "iconAnchor":[22,45],
                                "popupAnchor": [0,-25]
                            },
                            "ciudad":{
                                "iconUrl":"leaflet/images/icons/ciudad.png",
                                "iconSize":[45,45],
                                "iconAnchor":[22,45],
                                "popupAnchor": [0,-25]
                            }
                        }
                    },
                    "Ocresyn":{
                        "markers":{
                            "Vilonde":{
                                "location":[-24.307053, 70.532227],
                                "draggable":false,
                                "icon":"VilondeIcon",
                                "bindPopup":"Capital de Ocresyn: Vilonde"
                            }
                        },
                        "icons":{
                            "Vilonde":{
                                "iconUrl":"leaflet/images/ocresyn.png",
                                "iconSize":[60,60],
                                "iconAnchor":[30,60],
                                "popupAnchor": [0,-40]
                            }
                        }
                    },
                    "Perterra":{
                        "markers":{
                            "Fetlond":{
                                "location":[-13.816744, 37.507324],
                                "draggable":false,
                                "icon":"FetlondIcon",
                                "bindPopup":"Capital de Perterra: Fetlond"
                            }
                        },
                        "icons":{
                            "Fetlond":{
                                "iconUrl":"leaflet/images/perterra.png",
                                "iconSize":[60,60],
                                "iconAnchor":[30,60],
                                "popupAnchor": [0,-40]
                            }
                        }
                    },
                    "Nowe":{
                        "markers":{
                            "Zunzir":{
                                "location":[-8.05923, 0.505371],
                                "draggable":false,
                                "icon":"ZunzirIcon",
                                "bindPopup":"Capital de Nowe: Zunzir"
                            }
                        },
                        "icons":{
                            "Zunzir":{
                                "iconUrl":"leaflet/images/nowe.png",
                                "iconSize":[60,60],
                                "iconAnchor":[30,60],
                                "popupAnchor": [0,-40]
                            }
                        }
                    },
                    "Lagros":{
                        "markers":{
                            "Baranun":{
                                "location":[-13.731381, -59.963379],
                                "draggable":false,
                                "icon":"BaranunIcon",
                                "bindPopup":"Capital de Lagros: Baranun"
                            }
                        },
                        "icons":{
                            "Baranun":{
                                "iconUrl":"leaflet/images/lagros.png",
                                "iconSize":[60,60],
                                "iconAnchor":[30,60],
                                "popupAnchor": [0,-40]
                            }
                        }
                    },
                    "Vopna":{
                        "markers":{
                            "Raumerin":{
                                "location":[20.344627, 24.191895],
                                "draggable":false,
                                "icon":"RaumerinIcon",
                                "bindPopup":"Capital de Vopna: Raumerin"
                            }
                        },
                        "icons":{
                            "Raumerin":{
                                "iconUrl":"leaflet/images/vopna.png",
                                "iconSize":[60,60],
                                "iconAnchor":[30,60],
                                "popupAnchor": [0,-40]
                            }
                        }
                    }
                },
                "cities":{
                    "Filtana":{
                        "markers":{
                            "templo":{
                                "location":[56.12106, 12.744141],
                                "draggable":true,
                                "bindPopup":"Templo Exegia Norte"
                            },
                            "templo2":{
                                "location":[16.88866, 10.063477],
                                "draggable":false,
                                "bindPopup":"Templo Exegia Centro"
                            },
                            "templo3":{
                                "location":[-40.680638, 9.84375],
                                "draggable":false,
                                "bindPopup":"Templo Exegia Centro"
                            },
                            "posada":{
                                "location":[-8.711358875426512, 18.149414062500004],
                                "draggable":false,
                                "bindPopup":"Taberna Bru - "
                            },
                            "magos":{
                                "location":[-12.168225677390119,11.997070312500002],
                                "draggable":false,
                                "bindPopup":"Tienda de Zerba"
                            },
                            "oculto":{
                                "location":[3.0746950723696944,0.9667968750000001],
                                "draggable":false,
                                "bindPopup":"Universidad de Couria"
                            },
                            "poi":{
                                "location":[12.168225677390119,-30.805664062500004],
                                "draggable":false,
                                "bindPopup":"Villa de Moira"
                            },
                            "poi2":{
                                "location":[1.537901237431487,-49.83398437500001],
                                "draggable":false,
                                "bindPopup":"Baños termales"
                            },
                            "poi3":{
                                "location":[4.258768357308007,-48.60351562500001],
                                "draggable":false,
                                "bindPopup":"Burdel"
                            },
                            "puerto":{
                                "location":[35.209721645221386,37.66113281250001],
                                "draggable":false,
                                "bindPopup":"Puerto"
                            }
                        },
                        "NPC":{
                            "Bru":"leaflet/images/NPC/Filtana/bru.png",
                            "Elalar":"leaflet/images/NPC/Filtana/elalar.png",
                            "Gizzim":"leaflet/images/NPC/Filtana/gizzim.png",
                            "Hask":"leaflet/images/NPC/Filtana/hask.png",
                            "Indoris":"leaflet/images/NPC/Filtana/indoris.png",
                            "Korthum":"leaflet/images/NPC/Filtana/korthum.png",
                            "Luvalur":"leaflet/images/NPC/Filtana/luvalur.png",
                            "Neridi":"leaflet/images/NPC/Filtana/neridi.png",
                            "Nube":"leaflet/images/NPC/Filtana/nube.png",
                            "Oririe":"leaflet/images/NPC/Filtana/oririe.png",
                            "Verjer":"leaflet/images/NPC/Filtana/verjer.png",
                            "Zerba":"leaflet/images/NPC/Filtana/zerba.png"
                        }
                    },
                    "Lati":{
                        
                    },
                    "Parta":{
                        "markers":{
                            "puente":{
                                "location":[21.616579336740603,38.3203125],
                                "draggable":false,
                                "bindPopup":"Puente"
                            },
                            "puerto":{
                                "location":[-5.0909441750333855,28.4765625],
                                "draggable":false,
                                "bindPopup":"Puerto de Parta"
                            },
                            "establos":{
                                "location":[-10.962764256386821,-55.19531250000001],
                                "draggable":false,
                                "bindPopup":"Establos de Vadrug"
                            },
                            "posada":{
                                "location":[-1.2303741774326018,-18.193359375000004],
                                "draggable":false,
                                "bindPopup":"Posada de Nethbis"
                            },
                            "templo":{
                                "location":[21.12549763660629,7.382812500000001],
                                "draggable":false,
                                "bindPopup":"Templo a Exegis y Keeus"
                            },
                            "magos":{
                                "location":[-6.708253968671543,-37.48535156250001],
                                "draggable":false,
                                "bindPopup":"Tienda de Kelkian"
                            }
                        },
                        "NPC":{
                            "Galden":"leaflet/images/NPC/Parta/galden.png",
                            "Kelkian":"leaflet/images/NPC/Parta/kelkian.png",
                            "Nethbis":"leaflet/images/NPC/Parta/nethbis.png",
                            "Vadrug, el mejor goblin habido y por haber, aunque parezca un firbolg":"leaflet/images/NPC/Parta/vadrug.png"
                        }
                    },
                    "Veno":{
                        "markers":{
                            "templo":{
                                "location":[41.77131167976407,29.003906250000004],
                                "draggable":false,
                                "bindPopup":"Templo de Ikved a Exegis"
                            },
                            "casa":{
                                "location":[35.746512259918504,34.27734375000001],
                                "draggable":false,
                                "bindPopup":"Mansión del Barón de Veno"
                            },
                            "sastre":{
                                "location":[7.536764322084078,33.75000000000001],
                                "draggable":false,
                                "bindPopup":"Sastería de Belace"
                            },
                            "posada":{
                                "location":[4.039617826768437, 13.798828125000002],
                                "draggable":false,
                                "bindPopup":"Los ocho calderos - Posada de Ninoa"
                            }
                        },
                        "NPC":{
                            "Barón":"leaflet/images/NPC/Veno/magdeg.png",
                            "Belace":"leaflet/images/NPC/Veno/belace.png",
                            "Fargrom":"leaflet/images/NPC/Veno/fargrom.png",
                            "Gilgamesh":"leaflet/images/NPC/Veno/gilgamesh.png",
                            "Lid":"leaflet/images/NPC/Veno/lid.png",
                            "Norgin":"leaflet/images/NPC/Veno/norgin.png",
                            "Shisla":"leaflet/images/NPC/Veno/shisla.png",
                            "Yaquinn":"leaflet/images/NPC/Veno/yaquinn.png",
                            "Zhol":"leaflet/images/NPC/Veno/zhol.png"
                        }
                    },
                    "Gonfenoire":{
                        "markers":{
                            "templo":{
                                "location":[-10.141931686131018,12.48046875],
                                "draggable":false,
                                "bindPopup":"Templo a Eae"
                            },
                            "templo":{
                                "location":[4.12728532324537,4.306640625000001],
                                "draggable":false,
                                "bindPopup":"Tributo"
                            },
                            "posada":{
                                "location":[15.072123545811683,44.12109375],
                                "draggable":false,
                                "bindPopup":"El loro vengativo"
                            },
                            "posada2":{
                                "location":[29.53522956294847,-6.416015625000001],
                                "draggable":false,
                                "bindPopup":"Barril Vacío"
                            },
                            "poi":{
                                "location":[-19.020577110966798,-2.7246093750000004],
                                "draggable":false,
                                "bindPopup":"Ojos de serpiente"
                            },
                            "forja":{
                                "location":[-2.152813583128846,-36.12304687500001],
                                "draggable":false,
                                "bindPopup":"Metal ideal"
                            },
                            "forja2":{
                                "location":[10.617418067950293,28.608398437500004],
                                "draggable":false,
                                "bindPopup":"Fuegos azules"
                            },
                            "cementerio":{
                                "location":[-29.382175075145277,-15.996093750000002],
                                "draggable":false,
                                "bindPopup":"Cementerio de Gonfenoire"
                            },
                            "tienda":{
                                "location":[15.961329081596647,15.556640625000002],
                                "draggable":false,
                                "bindPopup":"Mercado de Gonfenoire"
                            }
                        }
                    }
                },
                "genericIcons":{
                    "alquimista":{
                        "iconUrl":"leaflet/images/icons/alquimista.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Alquimista"
                    },
                    "arboleda":{
                        "iconUrl":"leaflet/images/icons/arboleda.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Arboleda"
                    },
                    "arsenal":{
                        "iconUrl":"leaflet/images/icons/arsenal.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Arsenal"
                    },
                    "banco":{
                        "iconUrl":"leaflet/images/icons/banco.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Banco"
                    },
                    "campamento":{
                        "iconUrl":"leaflet/images/icons/campamento.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Campamento"
                    },
                    "campodebatalla":{
                        "iconUrl":"leaflet/images/icons/campodebatalla.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Batalla"
                    },
                    "campodebatallaboss":{
                        "iconUrl":"leaflet/images/icons/campodebatallaboss.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Batalla finalizada"
                    },
                    "caravana":{
                        "iconUrl":"leaflet/images/icons/caravana.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Caravana"
                    },
                    "casa":{
                        "iconUrl":"leaflet/images/icons/casa.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Casa"
                    },
                    "cementerio":{
                        "iconUrl":"leaflet/images/icons/cementerio.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Cementerio"
                    },
                    "ciudad":{
                        "iconUrl":"leaflet/images/icons/ciudad.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Ciudad"
                    },
                    "color":{
                        "iconUrl":"leaflet/images/icons/color.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Tintes"
                    },
                    "cripta":{
                        "iconUrl":"leaflet/images/icons/cripta.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Cripta"
                    },
                    "cueva":{
                        "iconUrl":"leaflet/images/icons/cueva.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Cueva"
                    },
                    "dungeon":{
                        "iconUrl":"leaflet/images/icons/dungeon.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Dungeon"
                    },
                    "encantamiento":{
                        "iconUrl":"leaflet/images/icons/encantamiento.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Encantamientos"
                    },
                    "escudo":{
                        "iconUrl":"leaflet/images/icons/escudo.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Militar"
                    },
                    "establos":{
                        "iconUrl":"leaflet/images/icons/establos.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Establos"
                    },
                    "estado":{
                        "iconUrl":"leaflet/images/icons/estado.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Feudo"
                    },
                    "evento":{
                        "iconUrl":"leaflet/images/icons/evento.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Evento"
                    },
                    "faro":{
                        "iconUrl":"leaflet/images/icons/faro.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Faro"
                    },
                    "forja":{
                        "iconUrl":"leaflet/images/icons/forja.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Forja"
                    },
                    "forja2":{
                        "iconUrl":"leaflet/images/icons/forja.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Forja2"
                    },
                    "fort":{
                        "iconUrl":"leaflet/images/icons/fort.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Fuerte"
                    },
                    "fortaleza":{
                        "iconUrl":"leaflet/images/icons/fortaleza.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Fortaleza"
                    },
                    "granja":{
                        "iconUrl":"leaflet/images/icons/granja.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Granja"
                    },
                    "joyero":{
                        "iconUrl":"leaflet/images/icons/joyero.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Joyero" 
                    },
                    "luchador":{
                        "iconUrl":"leaflet/images/icons/luchador.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Mercenarios"
                    },
                    "madera":{
                        "iconUrl":"leaflet/images/icons/madera.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Carpintero"
                    },
                    "magos":{
                        "iconUrl":"leaflet/images/icons/magos.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Tienda mágica"
                    },
                    "mina":{
                        "iconUrl":"leaflet/images/icons/mina.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Mina"
                    },
                    "mueble":{
                        "iconUrl":"leaflet/images/icons/mueble.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Carpintero2"
                    },
                    "oculto":{
                        "iconUrl":"leaflet/images/icons/oculto.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Oculto/Estudio"
                    },
                    "peletero":{
                        "iconUrl":"leaflet/images/icons/peletero.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Peletero"
                    },
                    "posada":{
                        "iconUrl":"leaflet/images/icons/posada.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Posada"
                    },
                    "posada2":{
                        "iconUrl":"leaflet/images/icons/posada.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Posada2"
                    },
                    "posada3":{
                        "iconUrl":"leaflet/images/icons/posada.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Posada3"
                    },
                    "pueblo":{
                        "iconUrl":"leaflet/images/icons/pueblo.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Pueblo"
                    },
                    "puente":{
                        "iconUrl":"leaflet/images/icons/puente.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Puente"
                    },
                    "puerto":{
                        "iconUrl":"leaflet/images/icons/puerto.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Puerto"
                    },
                    "ruinas":{
                        "iconUrl":"leaflet/images/icons/ruinas.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Ruinas"
                    },
                    "sastre":{
                        "iconUrl":"leaflet/images/icons/sastre.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Sastre"
                    },
                    "templo":{
                        "iconUrl":"leaflet/images/icons/templo.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Templo"
                    },
                    "templo2":{
                        "iconUrl":"leaflet/images/icons/templo.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Templo2"
                    },
                    "templo3":{
                        "iconUrl":"leaflet/images/icons/templo.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Templo3"
                    },
                    "tienda":{
                        "iconUrl":"leaflet/images/icons/tienda.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Tienda general"
                    },
                    "torreon":{
                        "iconUrl":"leaflet/images/icons/torreon.png",
                        "iconSize":[35,35],
                        "iconAnchor":[20,35],
                        "popupAnchor": [-3,-18],
                        "literal":"Torreón"
                    },
                    "poi":{
                        "iconUrl":"leaflet/images/icons/poi.png",
                        "iconSize":[15,30],
                        "iconAnchor":[7,30],
                        "popupAnchor": [0,-22],
                        "literal":"Punto de interés"
                    },
                    "poi2":{
                        "iconUrl":"leaflet/images/icons/poi.png",
                        "iconSize":[15,30],
                        "iconAnchor":[7,30],
                        "popupAnchor": [0,-22],
                        "literal":"Punto de interés2"
                    },
                    "poi3":{
                        "iconUrl":"leaflet/images/icons/poi.png",
                        "iconSize":[15,30],
                        "iconAnchor":[7,30],
                        "popupAnchor": [0,-22],
                        "literal":"Punto de interés3"
                    }
                },
                "resumenes":{
                    "20220204":"/TalesOfEchia/resumenes/20220204.txt"
                }
            }

        //variables
            var resumen = "";
            var markers = [];
            var markersCity = [];
            var mapa;
            //party in function addMarkers
            $.each(BBDD.world,function(key,value){
                var pais = key;
                $.each(BBDD.world[pais].markers,function(key,value){
                    var city = key;
                    var nowThisMarker = this;
                    var iconsInThisCity = {};
                    $.each(BBDD.world[pais].icons,function(key,value){
                        var nowThisIconCity = this;
                        var Icon = L.icon({
                            iconUrl: nowThisIconCity.iconUrl,
                            iconSize: nowThisIconCity.iconSize,
                            iconAnchor: nowThisIconCity.iconAnchor,
                            popupAnchor: nowThisIconCity.popupAnchor
                        });
                        iconsInThisCity[key] = Icon;
                    })
                    var iconThisMarker;
                    if (nowThisMarker.tipoCiudad == "pueblo"){
                        iconThisMarker = iconsInThisCity["pueblo"]
                    }else if(nowThisMarker.tipoCiudad == "ciudad"){
                        iconThisMarker = iconsInThisCity["ciudad"]
                    }else{
                        iconThisMarker = iconsInThisCity[key]
                    }
                    var Marker = L.marker(nowThisMarker.location,{
                        draggable: nowThisMarker.draggable,
                        bindPopup: nowThisMarker.bindPopup,
                        icon: iconThisMarker
                    });
                    Marker.bindPopup(this.bindPopup);
                    markers.push(Marker);
                })
                
            })

        //functions
            
            function toggleLegendTable(){
                if ($('#legendTable').css('display') == "none"){
                    $('#legendTable').show();
                    $('#NPCTable').hide();
                    $('.listaSwitcher').hide();
                    $('.resumenesUL').hide();
                }else{
                    $('#legendTable').hide();
                }
            }
            function toggleLegendNPC(){
                if ($('#NPCTable').css('display') == "none"){
                    $('#NPCTable').show();
                    $('#legendTable').hide();
                    $('.listaSwitcher').hide();
                    $('.resumenesUL').hide();
                }else{
                    $('#NPCTable').hide();
                }
            }
            function addNPCCity(city){
                var counter=0;
                $.each(BBDD.cities[city].NPC,function(key,value){
                    var nombre = key;
                    var imagen = value;
                    var tr = $('<tr class="NPCTr"> </tr>');
                    var td1 = $('<td class="NPCSwitcher NPCLi"> <p>'+nombre+'</p></td>');
                    var td2 = $('<td class="NPCSwitcher NPCTd"> <img src="'+imagen+'" width="75px" height="75px" style="width:5em;height:5em;padding-right:2em"> </td>');
                    var lastTr = $('#NPCTable').children().last();
                        if (counter == 0){
                            $('#NPCTable').append(tr);
                            $(td1).appendTo(tr);
                            $(td2).appendTo(tr);
                        }else if(counter < 7){
                            $(td1).appendTo(lastTr);
                            $(td2).appendTo(lastTr);
                        }
                        counter++;
                        if (counter == 7) counter = 0;
                })
            }
            function loadLegendSwitcher(){
                var counter=0;
                $.each(BBDD.genericIcons,function(key,value){
                    var nombre = value.literal;
                    var imagen = value.iconUrl;
                    var x = value.iconSize[0];
                    var y = value.iconSize[1];
                    var regexsito = /[0-9]/;
                    if (!regexsito.test(nombre)){
                        var tr =  $('<tr class="legendTr"> </tr>');
                        var td1 = $('<td class="legendSwitcher legendTd"> <img src="'+imagen+'" width="'+x+'" height="'+y+'"> </td>');
                        var td2 = $('<td class="legendSwitcher legendLi"> <p>'+nombre+'</p></td>');
                        var lastTr = $('#legendTable').children().last();
                        if (counter == 0){
                            $('#legendTable').append(tr);
                            $(td1).appendTo(tr);
                            $(td2).appendTo(tr);
                        }else if(counter == 1 || counter == 2){
                            $(td1).appendTo(lastTr);
                            $(td2).appendTo(lastTr);
                        }
                        counter++;
                        if (counter == 3) counter = 0;
                    }
                })
            }
            function removeThisAndHide(){
                $('#textoResumen').hide();
                $('#textoResumen').find('h1').remove();
                $('#textoResumen').find('p').remove();
            }
            function loadResumenes(){
                $('.resumenesUL').find('li').remove();
                $.each(BBDD.resumenes,function(key,value){
                    console.log(key)
                    $('.resumenesUL').append('<li class="elementoSwitcher '+key+'Li"><button class="buttonswitcher '+key+'Button cityClick" link="'+value+'" id="'+key+'" onclick="showResumen(this)">'+key+'</button></li>')
                })
            }
            function getResumen(){
                if ($('.resumenesUL').css('display') == "none"){
                    $('.resumenesUL').show();
                    $('#legendTable').hide();
                    $('#NPCTable').hide();
                    $('.listaSwitcher').hide();
                }else{
                    $('.resumenesUL').hide();
                }
            }
            function showResumen(value){
                $('#textoResumen').find('h1').remove();
                $('#textoResumen').find('p').remove();
                var attributo = $(value).attr('link')
                var titulo = $(value).attr('id');
                var objeto =  $.get(attributo,function(txt){
                    $('#textoResumen').show().append('<h1>'+titulo+'</h1>');
                    $('#textoResumen').append('<p>'+txt+'</p>');
                })
                
            }
            function openTheCity(ciudad){
                $('#switcherCity').find('.buttonswitcher[link="'+ciudad+'"]').click();
            }
            //estandar
            function addNormalMap(){
                mapa = L.map('mapTalesOfEchia').setView([0,0],1); 
                L.tileLayer('Tiles/TilesNormalHex/{z}/{x}/{y}.png',{
                    minZoom:4,
                    maxZoom: 6,
                    conituousWorld: false,
                    noWrap: true
                }).addTo(mapa);
                addMarkers(mapa);
                
            }

            //regions
            function addRegionMap(){
                mapa = L.map('mapTalesOfEchia_Regions').setView([0,0],1); 
                L.tileLayer('Tiles/TilesRegions/{z}/{x}/{y}.png',{
                    minZoom:4,
                    maxZoom: 6,
                    conituousWorld: false,
                    noWrap: true
                }).addTo(mapa);
                addMarkers(mapa);
            }

            //topo      
            function addTopoMap(){
                mapa = L.map('mapTalesOfEchia_Topo').setView([0,0],1); 
                L.tileLayer('Tiles/TilesTopo/{z}/{x}/{y}.png',{
                    minZoom:4,
                    maxZoom: 6,
                    conituousWorld: false,
                    noWrap: true
                }).addTo(mapa);
                addMarkers(mapa);
            }

            //bio
            function addBioMap(){
                mapa = L.map('mapTalesOfEchia_Bio').setView([0,0],1); 
                L.tileLayer('Tiles/TilesBio/{z}/{x}/{y}.png',{
                    minZoom:4,
                    maxZoom: 6,
                    conituousWorld: false,
                    noWrap: true
                }).addTo(mapa);
                addMarkers(mapa);
            }

            //dynamicCity
            function addCity(city){
                mapa = L.map('map'+city).setView([0,0],1);
                L.tileLayer('Tiles/Tiles'+city+'/{z}/{x}/{y}.png',{
                    minZoom:3,
                    maxZoom: 5,
                    conituousWorld: false,
                    noWrap: true
                }).addTo(mapa);
                addMarkersCity(mapa,city);
                addNPCCity(city);
            }
            
            //remove maps of the body
            function resetEverything(){
                $('#NPCTable').hide();
                $('#legendTable').hide();
                $('.listaSwitcher').hide();
                $('#NPCTable').children().remove();
                mapa.remove();
                $('.customMap').remove();

            }
            
            //detect position --ERASE EVENTUALLY
            function addDetectPosition(mapa){
                mapa.on('click', function(e) {
                    console.log(e.latlng)
                    //console.log('"this":{\n"location":['+e.latlng+'],\n"draggable":false,\n"bindPopup":"bind"\n}')
                    //console.log('"this":{\n"iconUrl":"leaflet/images/icons/this.png",\n"iconSize":[35,35],\n"iconAnchor":[20,35],\n"popupAnchor": [-3,-18]\n}')
                });
            }

            //add markers
            function addMarkers(mapa){
                for (let i = 0; i < markers.length; i++) {
                    markers[i].addTo(mapa);
                }

                //PARTEY
                var partyIcon = L.icon({
                    iconUrl: 'leaflet/images/dndicon.png',
                    iconSize: [20, 20],
                    iconAnchor: [7, 20],
                    popupAnchor: [0, -18]
                });
                var party = L.marker([10.206813, 42.890625],{
                    draggable: false,
                    icon:partyIcon,
                })
                party.bindPopup('Party');
                party.addTo(mapa);

                //LocateTheParty
                party.on('dragend',function(e){
                    party.getPopup().setContent('Clicked'+ party.getLatLng().toString()).openOn(mapa);
                    updatePartyMarker();
                })
            }

            //add markers for city dynamic
            function addMarkersCity(mapa,city){
                $.each(BBDD.cities,function(key,value){
                    if (key == city){
                        $.each(BBDD.cities[city].markers,function(key,value){
                            var nowThisMarker = this;
                            var iconsInThisCity = {};
                            $.each(BBDD.cities[city].icons,function(key,value){
                                var nowThisIconCity = this; 
                                var Icon = L.icon({
                                    iconUrl: nowThisIconCity.iconUrl,
                                    iconSize: nowThisIconCity.iconSize,
                                    iconAnchor: nowThisIconCity.iconAnchor,
                                    popupAnchor: nowThisIconCity.popupAnchor
                                });
                                iconsInThisCity[key] = Icon;
                            })
                            $.each(BBDD.genericIcons,function(key,value){
                                var nowThisIconGeneral = this; 
                                var Icon = L.icon({
                                    iconUrl: nowThisIconGeneral.iconUrl,
                                    iconSize: nowThisIconGeneral.iconSize,
                                    iconAnchor: nowThisIconGeneral.iconAnchor,
                                    popupAnchor: nowThisIconGeneral.popupAnchor
                                });
                                iconsInThisCity[key] = Icon;
                            })
                            var Marker = L.marker(this.location,{
                                draggable: nowThisMarker.draggable,
                                bindPopup: nowThisMarker.bindPopup,
                                icon: iconsInThisCity[key]
                            });
                            Marker.bindPopup(this.bindPopup);
                            markersCity.push(Marker);
                        })
                        for (let i = 0; i < markersCity.length; i++) {
                            markersCity[i].addTo(mapa);
                        }
                        markersCity = [];
                    }
                })                
            }
            
            //updatePartyMarker
            function updatePartyMarker(party){
                
            }
        
        //On clicks
        //switcher mapas
            $('#normal').on('click',function(){
                resetEverything();
                $('body').append('<div id="mapTalesOfEchia" class="customMap"></div>');
                addNormalMap();
            })
            $('#regions').on('click',function(){
                resetEverything();
                $('body').append('<div id="mapTalesOfEchia_Regions" class="customMap"></div>');
                addRegionMap();
            })
            $('#topo').on('click',function(){
                resetEverything();
                $('body').append('<div id="mapTalesOfEchia_Topo" class="customMap"></div>');
                addTopoMap();
            })
            $('#bio').on('click',function(){
                resetEverything();
                $('body').append('<div id="mapTalesOfEchia_Bio" class="customMap"></div>');
                addBioMap();
            })
            $('.cityClick').on('click',function(){
                if (this.classList.contains('notYet')){
                    alert("Under construction!")
                }else{
                    var IdCity = $(this).attr('link');
                    resetEverything();
                    $('body').append('<div id="map'+IdCity+'" class="customMap"></div>');
                    addCity(IdCity);
                }
                
            })
            function onClickCityClick(){
                var IdCity = $(this).attr('link');
                resetEverything();
                $('body').append('<div id="map'+IdCity+'" class="customMap"></div>');
                addCity(IdCity);
            }
        //switcher ciudades
            $('#couria,#herug,#lagros,#nowe,#ocresyn,#perterra,#vopna').on('click',function(){
                if (this.classList.contains('notYet')){
                    alert("No has visitado este país!")
                }else{
                    var IdPais = this.id;
                    if ($('.'+IdPais+'UL').css('display') == "none"){
                        $('.'+IdPais+'UL').show();
                        $('#NPCTable').hide();
                        $('#legendTable').hide();
                    }else{
                        $('.'+IdPais+'UL').hide();
                    }
                }
            })

        //START of the actual execution
            $('body').append('<div id="mapTalesOfEchia" class="customMap"></div>');
            addNormalMap();
            loadResumenes();
            loadLegendSwitcher();
        </script>
    </body>
</html>